# Архитектура проекта DMarket Telegram Bot

## Общее описание

Данный проект представляет собой систему мониторинга цен на предметы торговой площадки DMarket с интеграцией Telegram-бота. Система построена на асинхронной архитектуре с использованием Python 3.11 и фреймворка asyncio.

## Основные компоненты

### 1. Парсер DMarket (`price_monitoring/parsers/dmarket`)

Модуль отвечает за взаимодействие с API DMarket и получение информации о предметах:
- Поиск предметов по критериям
- Получение подробной информации о предмете
- Отслеживание изменений цен
- Обработка ошибок сети и повторные попытки
- Поддержка прокси для обхода ограничений API

### 2. Воркеры обработки данных (`price_monitoring/worker/processing`)

Модули для асинхронной обработки данных в фоновом режиме:
- Периодические задачи мониторинга цен
- Фильтрация и обогащение данных
- Обработка событий изменения цен
- Подготовка уведомлений

### 3. Хранилище данных (`price_monitoring/storage`)

Компоненты для работы с Redis:
- Кеширование результатов запросов
- Хранение пользовательских настроек и предпочтений
- Хранение исторических данных о ценах
- Индексирование данных для быстрого поиска

### 4. Telegram-бот (корневая директория, `bot_handlers`)

Интерфейс взаимодействия с пользователями:
- Обработка команд и сообщений
- Меню и клавиатуры для навигации
- Система регистрации и авторизации пользователей
- Управление подписками на уведомления
- Поддержка нескольких языков

### 5. Система валидации (`price_monitoring/validation.py`, `config/validation.py`)

Компоненты для проверки и валидации данных:
- Валидаторы входящих запросов
- Проверка правильности настроек пользователей
- Нормализация данных

### 6. Мониторинг и логирование (`monitoring`)

Система отслеживания состояния сервисов:
- Структурированное JSON-логирование
- Трассировка запросов через Zipkin
- Метрики производительности
- Оповещения о сбоях

### 7. Общие компоненты (`common`)

Утилиты и вспомогательные функции:
- Автоматическое переподключение к Redis
- Автоматическое переподключение к RabbitMQ
- Вспомогательные функции для работы с асинхронным кодом
- Обработка ошибок и исключений

## Схема взаимодействия компонентов

1. Пользователь взаимодействует с Telegram-ботом, отправляя команды или сообщения
2. Telegram-бот обрабатывает входящие сообщения и передает запросы в соответствующие обработчики
3. Обработчики запросов используют парсер DMarket для получения информации
4. Результаты парсинга сохраняются в Redis для кэширования
5. Воркеры периодически обрабатывают данные о ценах и генерируют события
6. События публикуются в RabbitMQ для асинхронной обработки
7. Обработчики событий генерируют уведомления для пользователей
8. Уведомления отправляются пользователям через Telegram-бот

## Потоки данных

### Поток отслеживания цены предмета

```
Пользователь -> Telegram-бот -> Валидация запроса -> Парсер DMarket -> 
    -> Redis (кэширование) -> RabbitMQ (событие добавления отслеживания) -> 
    -> Воркер мониторинга -> Redis (сохранение настроек)
```

### Поток обработки изменения цены

```
Воркер мониторинга -> Парсер DMarket -> Сравнение с предыдущей ценой -> 
    -> Если цена изменилась -> RabbitMQ (событие изменения цены) ->
    -> Обработчик уведомлений -> Telegram-бот -> Пользователь
```

## Технологический стек

- **Python 3.11**: Основной язык программирования
- **asyncio**: Библиотека для асинхронного программирования
- **aiogram>=3.0.0**: Фреймворк для создания Telegram-ботов
- **aio-pika==9.4.1**: Клиент для работы с RabbitMQ
- **aioredis==2.0.0**: Клиент для работы с Redis
- **aiohttp>=3.9.0**: Клиент для HTTP-запросов
- **dataclasses-json>=0.5.7**: Библиотека для сериализации dataclass'ов
- **marshmallow>=3.16.0**: Библиотека для валидации данных
- **aiozipkin>=1.1.1**: Библиотека для трассировки запросов
- **json-logging>=1.3.0**: Библиотека для структурированного логирования

## Особенности реализации

1. **Асинхронность**: Все операции ввода-вывода выполняются асинхронно для максимальной производительности.
2. **Отказоустойчивость**: Автоматическое переподключение к Redis и RabbitMQ при потере соединения.
3. **Масштабируемость**: Возможность горизонтального масштабирования путем добавления дополнительных экземпляров воркеров.
4. **Локализация**: Поддержка нескольких языков интерфейса Telegram-бота.
5. **Конфигурируемость**: Все параметры могут быть настроены через переменные окружения и конфигурационные файлы.
6. **Тестируемость**: Компоненты спроектированы с учетом возможности модульного и интеграционного тестирования.
